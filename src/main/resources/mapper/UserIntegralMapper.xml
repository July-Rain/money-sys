<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lawschool.dao.UserIntegralDao">

  <!--获取用户积分学分总体信息-->
  <select id="getInfo" parameterType="com.lawschool.beans.User" resultType="com.lawschool.beans.UserIntegral">
SELECT
	USER_ID,
	INTEGRAL_POINT,
	ORG_CODE,
	ORG_NAME,
	FULL_NAME,
	USER_CODE,
	CREDIT_POINT,
	(
		SELECT
			allItrRank
		FROM
			(
				SELECT
					LUI.USER_ID,
					ROW_NUMBER () OVER (ORDER BY INTEGRAL_POINT) AS allItrRank
				FROM
					LAW_USER_INTEGRAL lui
			)
		WHERE
			USER_ID = #{id}
	) AS allItrRank,
	(
		SELECT
			orgItrRank
		FROM
			(
				SELECT
					LUI.USER_ID,
					ROW_NUMBER () OVER (ORDER BY INTEGRAL_POINT) AS orgItrRank
				FROM
					LAW_USER_INTEGRAL lui
				WHERE
					ORG_CODE = #{orgCode}
			)
		WHERE
			USER_ID = #{id}
	) AS orgItrRank,
	(
		SELECT
			allCdtRank
		FROM
			(
				SELECT
					LUI.USER_ID,
					ROW_NUMBER () OVER (ORDER BY CREDIT_POINT) AS allCdtRank
				FROM
					LAW_USER_INTEGRAL lui
			)
		WHERE
			USER_ID = #{id}
	) AS allCdtRank,
	(
		SELECT
			orgCdtRank
		FROM
			(
				SELECT
					LUI.USER_ID,
					ROW_NUMBER () OVER (ORDER BY CREDIT_POINT) AS orgCdtRank
				FROM
					LAW_USER_INTEGRAL lui
				WHERE
					ORG_CODE = #{orgCode}
			)
		WHERE
			USER_ID = #{id}
	) AS orgCdtRank
FROM
	LAW_USER_INTEGRAL
WHERE
	USER_ID = #{id}

  </select>


	<!--学分 人员-->
	<select id="crdStatUser" resultType="com.lawschool.beans.UserIntegral">
	SELECT
	USER_ID,
	ORG_CODE,
	FULL_NAME,
	USER_CODE,
	ORG_NAME,
	CREDIT_POINT,
	ROW_NUMBER () OVER (ORDER BY CREDIT_POINT) AS orgCdtRank,
	(SELECT allCdtRank FROM(
			SELECT LUI.USER_ID,ROW_NUMBER () OVER (ORDER BY CREDIT_POINT) AS allCdtRank FROM LAW_USER_INTEGRAL lui)
	  WHERE
		USER_ID = LAW_USER_INTEGRAL.USER_ID) as allCdtRank
	FROM
		LAW_USER_INTEGRAL
	WHERE
		ORG_CODE = #{orgCode}
	order by CREDIT_POINT
	</select>





<!--学分 部门-->
	<select id="crdStatOrg" resultType="com.lawschool.beans.CrdStatOrg">

	  select
		TAB.org_id as orgId,
		TAB.parent_id as parentId,
		TAB.org_level as orgLevel,
		TAB.org_name as OrgName,
		TAB.orgAllCrd,
		ROW_NUMBER () OVER (ORDER BY orgAllCrd desc nulls last) AS orgAllCrdRank
		from (
		select
		org_id,
		parent_id,
		org_level,
		org_name,
		(select sum(CREDIT_POINT)  from LAW_USER_INTEGRAL where ORG_CODE=LAW_ORG.org_code ) as orgAllCrd
		from LAW_ORG
		WHERE ORG_TYPE IN (10, 70, -1,0)   and org_status >=2000
		) tab
	</select>




<!--积分 人员-->
	<select id="itrStatUser" resultType="com.lawschool.beans.UserIntegral">
	SELECT
	USER_ID,
	ORG_CODE,
	FULL_NAME,
	USER_CODE,
	ORG_NAME,
	INTEGRAL_POINT,
	ROW_NUMBER () OVER (ORDER BY INTEGRAL_POINT) AS orgItrRank,
	(SELECT allItrRank FROM(
			SELECT LUI.USER_ID,ROW_NUMBER () OVER (ORDER BY INTEGRAL_POINT) AS allItrRank FROM LAW_USER_INTEGRAL lui)
	  WHERE
		USER_ID = LAW_USER_INTEGRAL.USER_ID) as allItrRank
	FROM
		LAW_USER_INTEGRAL
	WHERE
		ORG_CODE = #{orgCode}
	order by INTEGRAL_POINT
	</select>


	<!--积分 部门-->
	<select id="itrStatOrg" resultType="com.lawschool.beans.ItrStatOrg">
		select
			TAB.org_id as orgId,
			TAB.parent_id as parentId,
			TAB.org_level as orgLevel,
			TAB.org_name as OrgName,
			TAB.orgAllItr,
			ROW_NUMBER () OVER (ORDER BY orgAllItr desc nulls last) AS orgAllItrRank
		from (
				 select
					 org_id,
					 parent_id,
					 org_level,
					 org_name,
					 (select sum(INTEGRAL_POINT)  from LAW_USER_INTEGRAL where ORG_CODE=LAW_ORG.org_code ) as orgAllItr
				 from LAW_ORG
				 WHERE ORG_TYPE IN (10, 70, -1,0)   and org_status >=2000
			 ) tab
	</select>
</mapper>